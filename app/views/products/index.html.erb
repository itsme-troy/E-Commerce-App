<div class="products-page">

  <!-- Sidebar Filter -->
  <aside class="sidebar card shadow-sm p-4 rounded-3 bg-white">


    <label> Price</label> 
    <form id="price-form" action="<%= products_path %>" method="get">
        <div id="price-slider" class="mb-1"></div>

        <!-- Hidden fields for submission -->
        <input type="hidden" name="min_price" id="min-price-input" value="<%= params[:min_price] || 0 %>">
        <input type="hidden" name="max_price" id="max-price-input" value="<%= params[:max_price] || 5000 %>">

          <p class="price-display mb-4 text-muted">
            Price: ₱<span id="min-price-display"></span> – ₱<span id="max-price-display"></span>
        </p>
    </form>

<%# when user selects category, keeps min and max proce, query, applies selected category  %>  
    <label> Categories </label>
    <div class="category-scroll">     
        <ul class="list-unstyled category-list">
            <% @categories.each do |category| %>
                <li class="mb-2">
                <%= link_to category.name, products_path(
                        category_id: category.id,
                        min_price: params[:min_price],
                        max_price: params[:max_price],
                        query: params[:query]
                    ),
                    class: "category-link #{'active' if params[:category_id].to_i == category.id}" %>

                    <%# only show tags if this category is currently selected %> 
                    <% if params[:category_id].to_i == category.id && @tags.present? %> 
                        <div class="tag-list mt-2">
                            <% @tags.each do |tag| %>
                                <%= link_to tag.name, products_path(
                                    category_id: category.id, 
                                    tag_id: tag.id, 
                                    min_price: params[:min_price], 
                                    max_price: params[:max_price], 
                                    query: params[:query] 
                                ), class: "badge me-1 #{params[:tag_id].to_i == tag.id ? 'bg-primary text-white' : 'bg-light text-dark'} text-decoration-none" %>
                            <% end %>
                        </div>
                    <% end %>
                </li>
            <% end %>
        </ul>
    </div> 

    <div class="reset-button-wrapper">
        <%= link_to "Reset Filters", products_path, class: "btn btn-reset" %>
    </div>

  </aside>


  <!-- Main Content -->
  <div class="main-content">
    <div class="header-container">
      <h1 class="page-title">Products</h1>
      <div class="header-buttons">
            
        <% if Current.user.present? %>
        <div>
            Current role: <%= Current.user.role %>
        </div>
        <% end %>

        <% if Current.user&.role == "admin" %>     
            <%= link_to new_product_path, class: "btn btn-success icon-spacing responsive-button" do %>
                <i class="fas fa-plus"></i>
                <span class="button-text">New</span>
            <% end %>
        <% end %> 

        <%= form_with url: products_path, method: :get, local: true, class: "search-form" do %>
          <div class="search-wrapper">
            <%= text_field_tag :query, params[:query], placeholder: "Search product or tags", class: "search-input" %>
            <button type="submit" class="search-icon-btn">
              <i class="fas fa-search"></i>
            </button>
          </div>
        <% end %>
      </div> 
    </div>

    <!-- Product Table -->
    <table class="table table-hover table-bordered">
      <thead>
        <tr>
          <th>#</th>
          <th>Name</th>
          <th>Category</th>
          <th>Price</th>
        </tr>
      </thead>
      <tbody>
        <% if @products.any? %> 
            <% @products.each_with_index do |product, index| %>
            <tr onclick="window.location='<%= product_path(product) %>'" style="cursor: pointer;">
                <td class="counter-col"> <%= @products.offset_value + index + 1 %></td>
                <td><%= product.name %></td>
                <td><%= product.category&.name || "Uncategorized" %></td>
                <td>₱<%= number_with_precision(product.price || 0, precision: 2) %></td>
            </tr>
            <% end %>
        <% else %> 
            <tr> 
                <td colspan="4" class= "text-center text-muted"> No products found. </td>  
            </tr> 
        <% end %> 
      </tbody>
    </table>    

    <div class="pagination-stack-wrapper"> 
        <%# Pagination summary %>
        <% if @products.total_count > 0 %>
            <div class="pagination-summary text-muted text-end">
                Showing <%= @products.offset_value + 1 %>–
                <%= [@products.offset_value + @products.limit_value, @products.total_count].min %>
                of <%= @products.total_count %> products
            </div>
        <% end %>

        <%# Pagination controls %>
        <div class="pagination-controls">
            <%= paginate @products %>
        </div> 
    </div>

  </div>
</div>
